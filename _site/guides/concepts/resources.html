<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Graphiti</title>
  <meta name="description" content="Stylish Graph APIs">

  <link rel="stylesheet" href="https://graphiti-api.github.io/graphiti/assets/main.css?ref=wh4t3v45">
  <link rel="alternate" type="application/rss+xml" title="Graphiti" href="/feed.xml">

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-127904727-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-127904727-1');
  </script>

  <!-- javascript -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

  
</head>


  <body>
    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <header class="navbar navbar-inverse normal" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="https://graphiti-api.github.io/graphiti" class="navbar-brand">Graphiti</a>
    </div>
    <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
      <ul class="nav navbar-nav">
        <li>
          <a class="nav-link" href="https://graphiti-api.github.io/graphiti/quickstart">Quickstart</a>
        </li>
        <li>
          <a class="nav-link" href="https://graphiti-api.github.io/graphiti/guides">Guides</a>
        </li>
        <li>
          <a class="nav-link" href="https://graphiti-api.github.io/graphiti/tutorial">Tutorial</a>
        </li>
        <li>
          <a class="nav-link" href="https://graphiti-api.github.io/graphiti/js">Spraypaint</a>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right visible-md visible-lg">
        <li>
          <a href="https://github.com/graphiti-api/graphiti" class="button">Fork on Github</a>
        </li>
      </ul>
    </nav>
  </div>
</header>

        <div class="container">
          <div class="toc col-md-3">
  <h1 id="resources">Resources</h1>

  <ul>
    <li>1 <a href="#overview">Overview</a></li>
    <li>2 <a href="#attributes">Attributes</a>
      <ul>
        <li><a href="#limiting-behavior">Limiting Behavior</a></li>
        <li><a href="#default-behavior">Default Behavior</a></li>
        <li><a href="#customizing-display">Customizing Display</a>
          <ul>
            <li><a href="#explicit-serializers">Explicit Serializers</a></li>
          </ul>
        </li>
        <li><a href="#types">Types</a></li>
      </ul>
    </li>
    <li>3 <a href="#querying">Querying</a>
      <ul>
        <li><a href="#query-interface">Query Interface</a></li>
        <li><a href="#composing-with-scopes">Composing with Scopes</a></li>
        <li><a href="#basescope"><code class="highlighter-rouge">#base_scope</code></a></li>
        <li><a href="#sort">Sort</a>
          <ul>
            <li><a href="#sort-options">Sort Options</a></li>
          </ul>
        </li>
        <li><a href="#filter">Filter</a>
          <ul>
            <li><a href="#filter-options">Filter Options</a></li>
            <li><a href="#boolean-filter">Boolean Filter</a></li>
            <li><a href="#hash-filter">Hash Filter</a></li>
            <li><a href="#escaping-values">Escaping Values</a></li>
          </ul>
        </li>
        <li><a href="#statistics">Statistics</a></li>
        <li><a href="#resolve"><code class="highlighter-rouge">#resolve</code></a></li>
      </ul>
    </li>
    <li>4 <a href="#configuration">Configuration</a>
      <ul>
        <li><a href="#polymorphic-resources">Polymorphic Resources</a></li>
      </ul>
    </li>
    <li>5 <a href="#relationships">Relationships</a>
      <ul>
        <li><a href="#deep-queries">Deep Queries</a></li>
        <li><a href="#customizing-relationships">Customizing Relationships</a></li>
        <li><a href="#hasmany">has_many</a></li>
        <li><a href="#belongsto">belongs_to</a></li>
        <li><a href="#hasone">has_one</a></li>
        <li><a href="#manytomany">many_to_many</a></li>
        <li><a href="#polymorphicbelongsto">polymorphic_belongs_to</a></li>
        <li><a href="#polymorphichasmany">polymorphic_has_many</a></li>
      </ul>
    </li>
    <li>6 <a href="#generators">Generators</a></li>
    <li>7 <a href="#persisting">Persisting</a>
      <ul>
        <li><a href="#persistence-lifecycle-hooks">Lifecycle Hooks</a></li>
        <li><a href="#side-effects">Side Effects</a></li>
        <li><a href="#sideposting">Sideposting</a>
          <ul>
            <li><a href="#create">Create</a></li>
            <li><a href="#expanded-example">Expanded Example</a></li>
          </ul>
        </li>
        <li><a href="#validation-errors">Validation Errors</a></li>
      </ul>
    </li>
    <li>8 <a href="#context">Context</a></li>
    <li>9 Adapters</li>
  </ul>
</div>

<div class="col-md-8">

  <h2 id="overview">1 Overview</h2>

  <p>The same way a <code class="highlighter-rouge">Model</code> is an abstraction around a database table, a
<code class="highlighter-rouge">Resource</code> is an abstraction around an API endpoint. It holds logic for
<strong><em>querying</em></strong>, <strong><em>persisting</em></strong>, and <strong><em>serializing</em></strong> data.</p>

  <blockquote>
    <p>For a condensed view of the Resource interface, see the
<a href="https://graphiti-api.github.io/graphiti/cheatsheet">cheatsheet</a>.</p>
  </blockquote>

  <h2 id="attributes">2 Attributes</h2>

  <p>A <strong>Resource</strong> is composed of <strong>Attribute</strong>s. Each Attribute has a
<strong>name</strong> (e.g. <code class="highlighter-rouge">first_name</code>) that corresponds to a JSON key, and a
<strong>Type</strong> (e.g. <code class="highlighter-rouge">string</code>) that corresponds to a JSON value.</p>

  <p>To define an attribute:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">attribute</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:string</span></code></pre></figure>

  <h4 id="limiting-behavior">2.1 Limiting Behavior</h4>

  <p>Each attribute consists of four flags: <code class="highlighter-rouge">readable</code>, <code class="highlighter-rouge">writable</code>,
<code class="highlighter-rouge">sortable</code>, and <code class="highlighter-rouge">filterable</code>. Any of these flags can be turned off:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">attribute</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:string</span><span class="p">,</span> <span class="ss">sortable: </span><span class="kp">false</span></code></pre></figure>

  <p>Or use <code class="highlighter-rouge">only/except</code> shorthand:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">attribute</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:string</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:sortable</span><span class="p">]</span>
<span class="n">attribute</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:string</span><span class="p">,</span> <span class="ss">except: </span><span class="p">[</span><span class="ss">:writable</span><span class="p">]</span></code></pre></figure>

  <p>You might want to allow behavior only if a certain condition is met.
Pass a symbol to guard this behavior via corresponding method, only allowing the
behavior if the method returns <code class="highlighter-rouge">true</code>:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">attribute</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:string</span><span class="p">,</span> <span class="ss">writable: :admin?</span>

<span class="k">def</span> <span class="nf">admin?</span>
  <span class="c1"># ... logic ...</span>
<span class="k">end</span></code></pre></figure>

  <h4 id="default-behavior">2.2 Default Behavior</h4>

  <p>By default, attributes are enabled for all behavior. You may want to
disable certain behavior globally, for example a read-only API. Use
these properties to affect all subclasses:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">self</span><span class="p">.</span><span class="nf">attributes_readable_by_default</span> <span class="o">=</span> <span class="kp">false</span> <span class="c1"># default true</span>
<span class="nb">self</span><span class="p">.</span><span class="nf">attributes_writable_by_default</span> <span class="o">=</span> <span class="kp">false</span> <span class="c1"># default true</span>
<span class="nb">self</span><span class="p">.</span><span class="nf">attributes_filterable_by_default</span> <span class="o">=</span> <span class="kp">false</span> <span class="c1"># default true</span>
<span class="nb">self</span><span class="p">.</span><span class="nf">attributes_sortable_by_default</span> <span class="o">=</span> <span class="kp">false</span> <span class="c1"># default true</span></code></pre></figure>

  <h4 id="customizing-display">2.3 Customizing Display</h4>

  <p>Pass a block to <code class="highlighter-rouge">attribute</code> to customize display:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">attribute</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:string</span> <span class="k">do</span>
  <span class="vi">@object</span><span class="p">.</span><span class="nf">name</span><span class="p">.</span><span class="nf">upcase</span>
<span class="k">end</span></code></pre></figure>

  <p><code class="highlighter-rouge">@object</code> will be an instance of your model.</p>

  <h5 id="explicit-serializers">2.3.1 Explicit Serializers</h5>

  <p>TODO</p>

  <h4 id="types">2.4 Types</h4>

  <p>Each <strong>Attribute</strong> has a <strong>Type</strong>. Each <strong>Type</strong> defines behavior for</p>

  <ul>
    <li>Reading</li>
    <li>Writing</li>
    <li>Filtering</li>
  </ul>

  <p>For each of these, we’ll first attempt to <em>coerce</em> the given value to
the correct type. If that fails, we will raise an error.</p>

  <p>The implementation for each of these actions lives in a <a href="https://dry-rb.org/gems/dry-types">Dry Type</a>. Take the <code class="highlighter-rouge">:integer_id</code> type: here we want to <em>render</em> a string, but <em>query</em> with an integer (this is the default for all Resource <code class="highlighter-rouge">id</code> attributes):</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Graphiti</span><span class="o">::</span><span class="no">Types</span><span class="p">[</span><span class="ss">:integer_id</span><span class="p">]</span>

<span class="c1"># {</span>
<span class="c1">#   params: Dry::Types['coercible.integer'],</span>
<span class="c1">#   read: Dry::Types['coercible.string'],</span>
<span class="c1">#   write: Dry::Types['coercible.integer'],</span>
<span class="c1">#   ...</span>
<span class="c1"># }</span></code></pre></figure>

  <p>You can edit these implementations as you wish. Let’s make the <code class="highlighter-rouge">:string</code> type
render an integer:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Graphiti</span><span class="o">::</span><span class="no">Types</span><span class="p">[</span><span class="ss">:string</span><span class="p">][</span><span class="ss">:read</span><span class="p">]</span> <span class="o">=</span> <span class="no">Dry</span><span class="o">::</span><span class="no">Types</span><span class="p">[</span><span class="s1">'coercible.integer'</span><span class="p">]</span></code></pre></figure>

  <p>The built-in Types are:</p>

  <ul>
    <li><code class="highlighter-rouge">integer_id</code></li>
    <li><code class="highlighter-rouge">string</code></li>
    <li><code class="highlighter-rouge">integer</code></li>
    <li><code class="highlighter-rouge">big_decimal</code></li>
    <li><code class="highlighter-rouge">float</code></li>
    <li><code class="highlighter-rouge">date</code></li>
    <li><code class="highlighter-rouge">datetime</code></li>
    <li><code class="highlighter-rouge">uuid</code></li>
    <li><code class="highlighter-rouge">boolean</code></li>
    <li><code class="highlighter-rouge">hash</code></li>
    <li><code class="highlighter-rouge">array</code></li>
  </ul>

  <p>All but the last 3 have Array doppelgängers: <code class="highlighter-rouge">array_of_integers</code>,
<code class="highlighter-rouge">array_of_dates</code>, etc.</p>

  <p>The <code class="highlighter-rouge">integer_id</code> type says, “render as a string, but query as an
integer” and is the default for the <code class="highlighter-rouge">id</code> attribute. The <code class="highlighter-rouge">uuid</code> type says
“this is a string, but query me case-sensitive by default”.</p>

  <h5 id="custom-types">2.5 Custom Types</h5>

  <p><a href="https://dry-rb.org/gems/dry-types/custom-types">Dry Types supports custom types</a>. Let’s register a “capital letters” type:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># Define the Type</span>
<span class="n">definition</span> <span class="o">=</span> <span class="no">Dry</span><span class="o">::</span><span class="no">Types</span><span class="o">::</span><span class="no">Definition</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">String</span><span class="p">)</span>
<span class="n">type</span> <span class="o">=</span> <span class="n">definition</span><span class="p">.</span><span class="nf">constructor</span> <span class="k">do</span> <span class="o">|</span><span class="n">input</span><span class="o">|</span>
  <span class="n">input</span><span class="p">.</span><span class="nf">upcase</span>
<span class="k">end</span>

<span class="c1"># Register it with Graphiti</span>
<span class="no">Graphiti</span><span class="o">::</span><span class="no">Types</span><span class="p">[</span><span class="ss">:caps_lock</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">params: </span><span class="n">type</span><span class="p">,</span>
  <span class="ss">read: </span><span class="n">type</span><span class="p">,</span>
  <span class="ss">write: </span><span class="n">type</span><span class="p">,</span>
  <span class="ss">kind: </span><span class="s1">'scalar'</span><span class="p">,</span>
  <span class="ss">canonical_name: :caps_lock</span><span class="p">,</span>
  <span class="ss">description: </span><span class="s1">'All capital letters'</span>
<span class="p">}</span>

<span class="c1"># Use in a Resource</span>
<span class="n">attribute</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:caps_lock</span></code></pre></figure>

  <h2 id="querying">3 Querying</h2>

  <p>Resources must be able to dynamically compose a query that can be run
against an arbitrary backend (SQL, NoSQL, service calls, etc). They do
this through the concept of <strong>scoping</strong>.</p>

  <p>The best way to understand scoping is to take a look at what happens “under the hood”. Here’s the simple Resource, where most of the logic is hiding in the Adapter:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">PostResource</span> <span class="o">&lt;</span> <span class="no">ApplicationResource</span>
  <span class="n">attribute</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:string</span>
<span class="k">end</span></code></pre></figure>

  <p>Now let’s show the long-hand version. This is completely runnable code (we’re just overriding the default behavior with an explicit version of the same):</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">PostResource</span> <span class="o">&lt;</span> <span class="no">ApplicationResource</span>
  <span class="n">filter</span> <span class="ss">:title</span> <span class="k">do</span> <span class="o">|</span><span class="n">scope</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
    <span class="n">eq</span> <span class="k">do</span> <span class="o">|</span><span class="n">scope</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
      <span class="n">scope</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">title: </span><span class="n">value</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">sort</span> <span class="ss">:title</span> <span class="k">do</span> <span class="o">|</span><span class="n">scope</span><span class="p">,</span> <span class="n">dir</span><span class="o">|</span>
    <span class="n">scope</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="ss">title: </span><span class="n">dir</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">paginate</span> <span class="k">do</span> <span class="o">|</span><span class="n">scope</span><span class="p">,</span> <span class="n">current_page</span><span class="p">,</span> <span class="n">per_page</span><span class="o">|</span>
    <span class="n">scope</span><span class="p">.</span><span class="nf">page</span><span class="p">(</span><span class="n">current_page</span><span class="p">).</span><span class="nf">per</span><span class="p">(</span><span class="n">per_page</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">base_scope</span>
    <span class="no">Post</span><span class="p">.</span><span class="nf">all</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
    <span class="n">scope</span><span class="p">.</span><span class="nf">to_a</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <p>Let’s break this down the key elements:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">base_scope</span>
  <span class="no">Post</span><span class="p">.</span><span class="nf">all</span>
<span class="k">end</span></code></pre></figure>

  <p>Graphiti builds queries just like ActiveRecord: start with a base scope (<code class="highlighter-rouge">Post.all</code>), and alter that scope based on the incoming request. <code class="highlighter-rouge">#base_scope</code> defines our starting point.</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">filter</span> <span class="ss">:title</span> <span class="k">do</span> <span class="o">|</span><span class="n">scope</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
  <span class="n">eq</span> <span class="k">do</span> <span class="o">|</span><span class="n">scope</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
    <span class="n">scope</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">title: </span><span class="n">value</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <p>When the <code class="highlighter-rouge">title</code> query parameter is present, we alter the scope.</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
  <span class="n">scope</span><span class="p">.</span><span class="nf">to_a</span>
<span class="k">end</span></code></pre></figure>

  <p>The <code class="highlighter-rouge">#resolve</code> method is in charge of actually executing the query
and returning model instances.</p>

  <p>In other words, this code is roughly equivalent to:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">scope</span> <span class="o">=</span> <span class="no">Post</span><span class="p">.</span><span class="nf">all</span> <span class="c1"># #base_scope</span>
<span class="k">if</span> <span class="n">value</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:filter</span><span class="p">].</span><span class="nf">try</span><span class="p">(</span><span class="ss">:[]</span><span class="p">,</span> <span class="ss">:title</span><span class="p">)</span>
  <span class="n">scope</span> <span class="o">=</span> <span class="n">scope</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">title: </span><span class="n">value</span><span class="p">)</span> <span class="c1"># .filter</span>
<span class="k">end</span>
<span class="n">scope</span><span class="p">.</span><span class="nf">to_a</span> <span class="c1"># #resolve</span></code></pre></figure>

  <h4 id="query-interface">3.1 Query Interface</h4>

  <p>Resources can query and persist data without an API request or
response. To query, pass a <a href="http://jsonapi.org">JSONAPI-compliant</a> query hash:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">EmployeeResource</span><span class="p">.</span><span class="nf">all</span><span class="p">({</span>
  <span class="ss">filter: </span><span class="p">{</span> <span class="ss">first_name: </span><span class="s1">'Jane'</span> <span class="p">},</span>
  <span class="ss">sort: </span><span class="s1">'-created_at'</span><span class="p">,</span>
  <span class="ss">page: </span><span class="p">{</span> <span class="ss">size: </span><span class="mi">10</span><span class="p">,</span> <span class="ss">number: </span><span class="mi">2</span> <span class="p">}</span>
<span class="p">})</span></code></pre></figure>

  <p>The return value from <code class="highlighter-rouge">.all</code> is a <strong>proxy</strong> object, similar to
<code class="highlighter-rouge">ActiveRecord::Relation</code>:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># ActiveRecord:</span>
<span class="n">employees</span> <span class="o">=</span> <span class="no">Employee</span><span class="p">.</span><span class="nf">all</span>
<span class="n">employees</span><span class="p">.</span><span class="nf">class</span> <span class="c1"># ActiveRecord::Relation</span>
<span class="c1"># No query fires until .map</span>
<span class="n">employees</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:first_name</span><span class="p">)</span> <span class="c1"># =&gt; ["Jane", "Joe", ...]</span>

<span class="c1"># Graphiti Resource:</span>
<span class="n">employees</span> <span class="o">=</span> <span class="no">EmployeeResource</span><span class="p">.</span><span class="nf">all</span>
<span class="n">employees</span><span class="p">.</span><span class="nf">class</span> <span class="c1"># Graphiti::ResourceProxy</span>
<span class="c1"># No query fires until .map</span>
<span class="n">employees</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:first_name</span><span class="p">)</span> <span class="c1"># =&gt; ["Jane", "Joe", ...]</span>

<span class="c1"># Access model instances directly</span>
<span class="n">employees</span><span class="p">.</span><span class="nf">data</span> <span class="c1"># =&gt; [#&lt;Employee&gt;, #&lt;Employee&gt;, ...]</span></code></pre></figure>

  <p>This proxy object can render <a href="http://jsonapi.org">JSONAPI</a>, simple
JSON, or XML:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">employees</span> <span class="o">=</span> <span class="no">EmployeeResource</span><span class="p">.</span><span class="nf">all</span>
<span class="n">employees</span><span class="p">.</span><span class="nf">to_jsonapi</span>
<span class="n">employees</span><span class="p">.</span><span class="nf">to_json</span>
<span class="n">employees</span><span class="p">.</span><span class="nf">to_xml</span></code></pre></figure>

  <p>Use <code class="highlighter-rouge">.find</code> to find a single record by id, raising
<code class="highlighter-rouge">Graphiti::Errors::RecordNotFound</code> if no records are returned:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">employee</span> <span class="o">=</span> <span class="no">EmployeeResource</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="ss">id: </span><span class="mi">123</span><span class="p">)</span>
<span class="n">employee</span><span class="p">.</span><span class="nf">data</span><span class="p">.</span><span class="nf">first_name</span> <span class="c1"># =&gt; "Jane"</span></code></pre></figure>

  <h4 id="composing-with-scopes">3.2 Composing with Scopes</h4>

  <h4 id="basescope">3.3 <code class="highlighter-rouge">#base_scope</code></h4>

  <p>Override the <code class="highlighter-rouge">#base_scope</code> method whenever you have logic that should
apply to <em>every</em> query. For example, if we only ever wanted to return
<code class="highlighter-rouge">active</code> Positions:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">base_scope</span>
  <span class="no">Position</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">active: </span><span class="kp">true</span><span class="p">)</span>
<span class="k">end</span></code></pre></figure>

  <p>This can be overridden by passing a second argument to <code class="highlighter-rouge">Resource.all</code>:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">InactivePostsController</span> <span class="o">&lt;</span> <span class="no">PostsController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">posts</span> <span class="o">=</span> <span class="no">PostResource</span><span class="p">.</span><span class="nf">all</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="no">Post</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">active: </span><span class="kp">false</span><span class="p">))</span>
    <span class="n">respond_with</span><span class="p">(</span><span class="n">posts</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <h4 id="sort">3.4 Sort</h4>

  <p>Use the <code class="highlighter-rouge">sort</code> DSL to customize sorting behavior.</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">sort</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:string</span> <span class="k">do</span> <span class="o">|</span><span class="n">scope</span><span class="p">,</span> <span class="n">direction</span><span class="o">|</span>
  <span class="n">scope</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="ss">first_name: </span><span class="n">direction</span><span class="p">,</span> <span class="ss">last_name: </span><span class="n">direction</span><span class="p">)</span>
<span class="k">end</span></code></pre></figure>

  <p>If you’ve already defined a corresponding attribute, you’ll be
overriding that default behavior (and there is no need to pass a type as
the second argument):</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">attribute</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:string</span>

<span class="n">sort</span> <span class="ss">:name</span> <span class="k">do</span> <span class="o">|</span><span class="n">scope</span><span class="p">,</span> <span class="n">direction</span><span class="o">|</span>
  <span class="c1"># ... code ...</span>
<span class="k">end</span></code></pre></figure>

  <blockquote>
    <p>Note: <code class="highlighter-rouge">sort</code> defines a sort-only attribute. If you want other
behavior, like filtering, it’s best to define the attribute first.</p>
  </blockquote>

  <h5 id="sort-options">3.4.1 Sort Options</h5>

  <p>Pass <code class="highlighter-rouge">:only</code> if you support just a single direction:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">sort</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:desc</span><span class="p">]</span></code></pre></figure>

  <h4 id="filter">3.5 Filter</h4>

  <p>Use the <code class="highlighter-rouge">filter</code> DSL to customize each <em>operator</em>:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">filter</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:string</span> <span class="k">do</span>
  <span class="n">eq</span> <span class="k">do</span> <span class="o">|</span><span class="n">scope</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
    <span class="n">scope</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">first_name: </span><span class="n">value</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># prefix do ... end</span>
  <span class="c1"># suffix do ... end</span>
  <span class="c1"># etc</span>
<span class="k">end</span></code></pre></figure>

  <blockquote>
    <p>Note that Graphiti expects filters to support multiple values by
default, so <code class="highlighter-rouge">value</code> will be an array. Pass <code class="highlighter-rouge">single: true</code> if you do
not support multiple values.</p>
  </blockquote>

  <blockquote>
    <p>To pass multiple values in a query string, comma-delimit:
<code class="highlighter-rouge">/employees?filter[name]=Jane,John</code></p>
  </blockquote>

  <p>If you’ve already defined a corresponding attribute, you’ll be
overriding that default behavior (and there is no need to pass a type as
the second argument):</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">attribute</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:string</span>

<span class="n">filter</span> <span class="ss">:name</span> <span class="k">do</span>
  <span class="n">eq</span> <span class="k">do</span> <span class="o">|</span><span class="n">scope</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
    <span class="c1"># ... code ...</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <p>You can define custom operators on-the-fly:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">filter</span> <span class="ss">:name</span> <span class="k">do</span>
  <span class="n">fuzzy_match</span> <span class="k">do</span> <span class="o">|</span><span class="n">scope</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
    <span class="c1"># ... code ...</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <p>Will now support <code class="highlighter-rouge">filter[name][fuzzy_match]=foo</code></p>

  <blockquote>
    <p>Note: <code class="highlighter-rouge">filter</code> defines a filter-only attribute. If you want other
behavior, like sorting, it’s best to define the attribute first.</p>
  </blockquote>

  <h5 id="filter-options">3.5.1 Filter Options</h5>

  <p>Pass <code class="highlighter-rouge">:only</code> or <code class="highlighter-rouge">:except</code> to limit possible operators:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">filter</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:string</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:eq</span><span class="p">,</span> <span class="ss">:suffix</span><span class="p">]</span></code></pre></figure>

  <p>Pass <code class="highlighter-rouge">:allow</code> or <code class="highlighter-rouge">:reject</code> to only allow filtering on certain values, or
reject bad values:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">filter</span> <span class="ss">:size</span><span class="p">,</span> <span class="ss">:string</span><span class="p">,</span> <span class="ss">allow: </span><span class="p">[</span><span class="s1">'Big'</span><span class="p">,</span> <span class="s1">'Medium'</span><span class="p">,</span> <span class="s1">'Small'</span><span class="p">]</span>

<span class="n">filter</span> <span class="ss">:size</span><span class="p">,</span> <span class="ss">:string</span><span class="p">,</span> <span class="ss">reject: </span><span class="p">[</span><span class="s1">'X-Large'</span><span class="p">]</span></code></pre></figure>

  <p>By default, all filters accept multiple values, causing the yielded
<code class="highlighter-rouge">value</code> to always be an array. Pass <code class="highlighter-rouge">single: true</code> to only allow a
single value:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># Default behavior</span>
<span class="n">filter</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:string</span> <span class="k">do</span>
  <span class="n">eq</span> <span class="k">do</span> <span class="o">|</span><span class="n">scope</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
    <span class="n">value</span> <span class="c1"># =&gt; ["Jane"]</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># With single: true</span>
<span class="n">filter</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:string</span><span class="p">,</span> <span class="ss">single: </span><span class="kp">true</span> <span class="k">do</span>
  <span class="n">eq</span> <span class="k">do</span> <span class="o">|</span><span class="n">scope</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
    <span class="n">value</span> <span class="c1"># =&gt; "Jane"</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <p>Filters can be required:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># Via attribute</span>
<span class="n">attribute</span> <span class="ss">:customer_id</span><span class="p">,</span> <span class="ss">:integer</span><span class="p">,</span> <span class="ss">filterable: :required</span>

<span class="c1"># Via filter</span>
<span class="n">filter</span> <span class="ss">:customer_id</span><span class="p">,</span> <span class="ss">:string</span><span class="p">,</span> <span class="ss">required: </span><span class="kp">true</span></code></pre></figure>

  <p>Filters can also depend on other filters, requiring all criteria to be
present:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># We query customers by id AND type, not one or the other</span>
<span class="n">filter</span> <span class="ss">:customer_id</span><span class="p">,</span> <span class="ss">:integer</span><span class="p">,</span> <span class="ss">dependent: </span><span class="p">[</span><span class="ss">:customer_type</span><span class="p">]</span>
<span class="n">filter</span> <span class="ss">:customer_type</span><span class="p">,</span> <span class="ss">:string</span><span class="p">,</span> <span class="ss">dependent: </span><span class="p">[</span><span class="ss">:customer_id</span><span class="p">]</span></code></pre></figure>

  <h5 id="boolean-filter">3.5.2 Boolean Filter</h5>

  <p>It doesn’t make sense for a filter with type <code class="highlighter-rouge">boolean</code> to accept
multiple values. These filters will be <code class="highlighter-rouge">single: true</code> by default.</p>

  <h5 id="hash-filter">3.5.3 Hash Filter</h5>

  <p>Filters with type <code class="highlighter-rouge">hash</code> will automatically parse JSON when passed in a
URL query string:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># GET /employees?filter[metadata]={ "foo": 100 }</span>

<span class="n">filter</span> <span class="ss">:metadata</span><span class="p">,</span> <span class="ss">:hash</span> <span class="k">do</span>
  <span class="n">eq</span> <span class="k">do</span> <span class="o">|</span><span class="n">scope</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
    <span class="n">value</span> <span class="c1"># =&gt; [{ "foo" =&gt; 100 }]</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <h5 id="escaping-values">3.5.4 Escaping Values</h5>

  <p>By default, Graphiti parses a comma-delimited string as an array. There
are times you may not want this - for instance a “keyword search” field
that could contain a comma.</p>

  <p>Wrap values in <code class="highlighter-rouge"><span class="p">{</span><span class="err">{curlies</span><span class="p">}</span><span class="err">}</span></code> to avoid parsing:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># GET /employees?filter[keywords]={{some,value}}</span>

<span class="n">filter</span> <span class="ss">:keywords</span><span class="p">,</span> <span class="ss">:string</span> <span class="k">do</span>
  <span class="n">eq</span> <span class="k">do</span> <span class="o">|</span><span class="n">scope</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
    <span class="n">value</span> <span class="c1"># =&gt; "some,value"</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <p>You can also define arrays explicitly instead of delimiting on comma:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># GET /employees?filter[keywords]=[some,value]</span>

<span class="n">filter</span> <span class="ss">:keywords</span><span class="p">,</span> <span class="ss">:string</span> <span class="k">do</span>
  <span class="n">eq</span> <span class="k">do</span> <span class="o">|</span><span class="n">scope</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
    <span class="n">value</span> <span class="c1"># =&gt; ["some", "value"]</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <p>If a filter is marked <code class="highlighter-rouge">single: true</code>, we’ll avoid any array parsing and
escape the value for you, filtering on the string as given.</p>

  <h4 id="statistics">3.6 Statistics</h4>

  <p>Statistics are useful and common. Consider a datagrid listing posts - we might want a “Total Posts” count displayed above the grid without firing an additional request. Notably, that statistic <strong>should</strong> take into account filtering, but <strong>should not</strong> take into account pagination.</p>

  <p>All resources have a total count statistic by default:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">PostResource</span><span class="p">.</span><span class="nf">all</span><span class="p">({</span>
  <span class="ss">stats: </span><span class="p">{</span> <span class="ss">total: </span><span class="s1">'count'</span> <span class="p">}</span>
<span class="p">})</span></code></pre></figure>

  <p><code class="highlighter-rouge">/posts?stats[total]=count</code></p>

  <p>Would cause the <code class="highlighter-rouge">meta</code> section of the response to be:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="p">{</span>
  <span class="ss">meta: </span><span class="p">{</span>
    <span class="ss">stats: </span><span class="p">{</span>
      <span class="ss">total: </span><span class="p">{</span>
        <span class="ss">count: </span><span class="mi">100</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

  <p>Allow a given statistic to be requested using <code class="highlighter-rouge">.stat</code>:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">stat</span> <span class="ss">total: </span><span class="p">[</span><span class="ss">:count</span><span class="p">]</span>
<span class="n">stat</span> <span class="ss">rating: </span><span class="p">[</span><span class="ss">:average</span><span class="p">]</span>
<span class="n">stat</span> <span class="ss">likes: </span><span class="p">[</span><span class="ss">:sum</span><span class="p">]</span>
<span class="n">stat</span> <span class="ss">score: </span><span class="p">[</span><span class="ss">:maximum</span><span class="p">]</span>
<span class="n">stat</span> <span class="ss">score: </span><span class="p">[</span><span class="ss">:maximum</span><span class="p">]</span>

<span class="c1"># e.g.</span>
<span class="c1"># {</span>
<span class="c1">#   meta: {</span>
<span class="c1">#     stats: {</span>
<span class="c1">#       rating: {</span>
<span class="c1">#         average: 74</span>
<span class="c1">#       }</span>
<span class="c1">#     }</span>
<span class="c1">#   }</span>
<span class="c1"># }</span></code></pre></figure>

  <p>You can also define custom statistics:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">stat</span> <span class="ss">rating: </span><span class="p">[</span><span class="ss">:average</span><span class="p">]</span> <span class="k">do</span>
  <span class="n">standard_deviation</span> <span class="k">do</span> <span class="o">|</span><span class="n">scope</span><span class="p">,</span> <span class="kp">attr</span><span class="o">|</span>
    <span class="c1"># your standard deviation code here</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <h4 id="resolve">3.7 <code class="highlighter-rouge">#resolve</code></h4>

  <p>After we build up a query, we pass it to <code class="highlighter-rouge">#resolve</code>. Resolve <strong>must</strong> do
two things:</p>

  <ul>
    <li>Execute the query</li>
    <li>Return an array of <code class="highlighter-rouge">Model</code> instances</li>
  </ul>

  <p>Override <code class="highlighter-rouge">#resolve</code> if you need more than the default behavior:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
  <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span> <span class="s2">"begin resolving scope..."</span>
  <span class="n">result</span> <span class="o">=</span> <span class="k">super</span>
  <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span> <span class="s2">"resolved!"</span>
  <span class="n">result</span>
<span class="k">end</span></code></pre></figure>

  <h2 id="configuration">4 Configuration</h2>

  <p>Here’s a Resource with explicit defaults:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">PostResource</span> <span class="o">&lt;</span> <span class="no">ApplicationResource</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">model</span> <span class="o">=</span> <span class="no">Post</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">type</span> <span class="o">=</span> <span class="s1">'posts'</span>

  <span class="c1"># Only used if you care about Links</span>
  <span class="n">primary_endpoint</span> <span class="s1">'/posts'</span><span class="p">,</span> <span class="p">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">]</span>

  <span class="c1"># default nil</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">default_sort</span> <span class="o">=</span> <span class="p">[{</span> <span class="ss">title: :asc</span> <span class="p">}]</span>

  <span class="c1"># default 20</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">default_page_size</span> <span class="o">=</span> <span class="mi">10</span>
<span class="k">end</span></code></pre></figure>

  <p>Typically you’d inherit from <code class="highlighter-rouge">ApplicationResource</code>. Here are some common higher-level customization options that will affect subclasses:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">ApplicationResource</span> <span class="o">&lt;</span> <span class="no">Graphiti</span><span class="o">::</span><span class="no">Resource</span>
  <span class="c1"># Must be set when no corresponding model/query</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">abstract_class</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="c1"># Subclasses can override if needed</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">adapter</span> <span class="o">=</span> <span class="no">Graphiti</span><span class="o">::</span><span class="no">Adapters</span><span class="o">::</span><span class="no">ActiveRecord</span>

  <span class="c1"># Default attribute flags:</span>
  <span class="c1"># attribute :title, :string,</span>
  <span class="c1">#   readable: default,</span>
  <span class="c1">#   writable: default,</span>
  <span class="c1">#   sortable: default,</span>
  <span class="c1">#   filterable: default</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">attributes_readable_by_default</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">attributes_writable_by_default</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">attributes_sortable_by_default</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">attributes_filterable_by_default</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="c1"># Used for link generation</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">base_url</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">default_url_options</span><span class="p">[</span><span class="ss">:host</span><span class="p">]</span>
  <span class="c1"># Used for link generation</span>
  <span class="c1"># Suggest referencing this config/routes.rb:</span>
  <span class="c1"># scope path: ApplicationResource.endpoint_namespace do</span>
  <span class="c1">#   resources :posts</span>
  <span class="c1"># end</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">endpoint_namespace</span> <span class="o">=</span> <span class="s1">'/api/v1'</span>

  <span class="c1"># Will raise an error if a resource is being accessed from a URL it is not allowlisted for</span>
  <span class="c1"># Helpful for link validation</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">validate_endpoints</span> <span class="o">=</span> <span class="kp">false</span>

  <span class="c1"># Automatically generate JSONAPI links?</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">autolink</span> <span class="o">=</span> <span class="kp">true</span>
<span class="k">end</span></code></pre></figure>

  <h3 id="polymorphic-resources">4.1 Polymorphic Resources</h3>

  <p>Polymorphic Resources are similar to <a href="https://api.rubyonrails.org/classes/ActiveRecord/Inheritance.html">ActiveRecord STI</a>: when a single query can return multiple Resource instances. We may query <code class="highlighter-rouge">/tasks</code>, but return <code class="highlighter-rouge">bugs</code>, <code class="highlighter-rouge">features</code>, <code class="highlighter-rouge">epics</code>, etc.</p>

  <p>For example, given the <code class="highlighter-rouge">ActiveRecord</code> models:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Employee</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:tasks</span>
<span class="k">end</span>

<span class="c1"># tasks table has a 'type' column</span>
<span class="k">class</span> <span class="nc">Task</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:employee</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Bug</span> <span class="o">&lt;</span> <span class="no">Task</span>
<span class="k">end</span>

<span class="c1"># ONLY Feature has #points</span>
<span class="k">class</span> <span class="nc">Feature</span> <span class="o">&lt;</span> <span class="no">Task</span>
  <span class="k">def</span> <span class="nf">points</span>
    <span class="mi">5</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># ONLY Epic has the milestones relationship</span>
<span class="k">class</span> <span class="nc">Epic</span> <span class="o">&lt;</span> <span class="no">Task</span>
  <span class="n">has_many</span> <span class="ss">:milestones</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Milestone</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:epic</span>
<span class="k">end</span></code></pre></figure>

  <p>We could define the following Polymorphic Resources:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">TaskResource</span> <span class="o">&lt;</span> <span class="no">ApplicationResource</span>
  <span class="c1"># Reference child classes</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">polymorphic</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'BugResource'</span><span class="p">,</span>
    <span class="s1">'FeatureResource'</span><span class="p">,</span>
    <span class="s1">'EpicResource'</span>
  <span class="p">]</span>

  <span class="n">attribute</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:string</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">BugResource</span> <span class="o">&lt;</span> <span class="no">TaskResource</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">FeatureResource</span> <span class="o">&lt;</span> <span class="no">TaskResource</span>
  <span class="n">attribute</span> <span class="ss">:points</span><span class="p">,</span> <span class="ss">:integer</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">EpicResource</span> <span class="o">&lt;</span> <span class="no">TaskResource</span>
  <span class="n">has_many</span> <span class="ss">:milestones</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">MilestoneResource</span> <span class="o">&lt;</span> <span class="no">TaskResource</span>
  <span class="n">belongs_to</span> <span class="ss">:epic</span>
<span class="k">end</span></code></pre></figure>

  <p>If we hit a <code class="highlighter-rouge">/tasks</code> endpoint, we’d get back <a href="http://jsonapi.org/format/#document-resource-identifier-objects">JSONAPI types</a> of <code class="highlighter-rouge">bugs</code>, <code class="highlighter-rouge">features</code> and <code class="highlighter-rouge">epics</code>. Only <code class="highlighter-rouge">features</code> would render the <code class="highlighter-rouge">points</code> attribute, and only <code class="highlighter-rouge">epics</code> would render the <code class="highlighter-rouge">milestones relationship</code>.</p>

  <p>A query to <code class="highlighter-rouge">/tasks?include=milestones</code> would correctly only query
and render Milestones for Epics.</p>

  <h2 id="relationships">5 Relationships</h2>

  <p>Resources can connect to other Resources via <strong>relationships</strong>.
Each relationship determines behavior for:</p>

  <ul>
    <li>Sideloading (load both Resources in a single request)</li>
    <li>Links (URL to lazy-load in separate request)</li>
    <li>Sideposting (save both in single request)</li>
  </ul>

  <p>When connecting resources, you can imagine the logic similar to
<code class="highlighter-rouge">ActiveRecord</code>’s <code class="highlighter-rouge">.includes</code>:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">PostResource</span> <span class="o">&lt;</span> <span class="no">ApplicationResource</span>
  <span class="n">has_many</span> <span class="ss">:comments</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">CommentResource</span> <span class="o">&lt;</span> <span class="no">ApplicationResource</span>
  <span class="n">attribute</span> <span class="ss">:post_id</span><span class="p">,</span> <span class="ss">:integer</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:filterable</span><span class="p">]</span>
  <span class="n">belongs_to</span> <span class="ss">:post</span>
<span class="k">end</span>

<span class="no">PostResource</span><span class="p">.</span><span class="nf">all</span><span class="p">(</span><span class="ss">includes: </span><span class="s1">'comments'</span><span class="p">)</span>
<span class="c1"># Under the hood:</span>
<span class="c1"># CommentResource.all(filter: { post_id: array_of_post_ids })</span>

<span class="no">CommentResource</span><span class="p">.</span><span class="nf">all</span><span class="p">(</span><span class="ss">includes: </span><span class="s1">'post'</span><span class="p">)</span>
<span class="c1"># Under the hood:</span>
<span class="c1"># PostResource.all(filter: { id: array_of_comment_ids })</span></code></pre></figure>

  <blockquote>
    <p>Note the explicit <code class="highlighter-rouge">post_id</code> filter on <code class="highlighter-rouge">CommentResource</code></p>
  </blockquote>

  <h3 id="deep-queries">5.1 Deep Queries</h3>

  <p>A query that applies to a relationship is referred to as a <strong>deep
query</strong>. Use the dot-syntax to deep query:</p>

  <p><code class="highlighter-rouge">/employees?include=positions&amp;filter[positions.title]=Manager</code></p>

  <p><code class="highlighter-rouge">/employees?include=positions.department&amp;filter[positions.department.name]=Engineering</code></p>

  <p>The above references the <strong>relationship name</strong>. For simplicity, you can
also pass the JSONAPI type in brackets:</p>

  <p><code class="highlighter-rouge">/employees?include=positions.department&amp;filter[departments][name]=Engineering</code></p>

  <p>Sorting and pagination currently only support the JSONAPI type:</p>

  <p><code class="highlighter-rouge">/employees?include=positions.department&amp;sort=departments.name</code></p>

  <p><code class="highlighter-rouge">/employees?include=positions.department&amp;page[departments][size]=10</code></p>

  <h4 id="customizing-relationships">5.2 Customizing Relationships</h4>

  <p>The default options you can override are:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">has_many</span> <span class="ss">:positions</span><span class="p">,</span>
  <span class="ss">foreign_key: :employee_id</span><span class="p">,</span>
  <span class="ss">primary_key: :id</span><span class="p">,</span>
  <span class="ss">resource: </span><span class="no">EmployeeResource</span><span class="p">,</span>
  <span class="ss">readable: </span><span class="kp">true</span><span class="p">,</span>
  <span class="ss">writable: </span><span class="kp">true</span><span class="p">,</span>
  <span class="ss">link: </span><span class="nb">self</span><span class="p">.</span><span class="nf">autolink</span> <span class="c1"># default true</span>
  <span class="ss">single: </span><span class="kp">false</span> <span class="c1"># only allow this sideload when one employee</span></code></pre></figure>

  <p>Use <code class="highlighter-rouge">params</code> to change the query parameters that will be passed to the
associated Resource:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">has_many</span> <span class="ss">:active_positions</span> <span class="k">do</span>
  <span class="n">params</span> <span class="k">do</span> <span class="o">|</span><span class="nb">hash</span><span class="o">|</span>
    <span class="nb">hash</span><span class="p">[</span><span class="ss">:filter</span><span class="p">][</span><span class="ss">:active</span><span class="p">]</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Would cause the underlying query:</span>
<span class="c1">#</span>
<span class="c1"># PositionResource.all({</span>
<span class="c1">#   filter: {</span>
<span class="c1">#     employee_id: array_of_employee_ids</span>
<span class="c1">#     active: true</span>
<span class="c1">#   }</span>
<span class="c1"># })</span></code></pre></figure>

  <p>Once we’ve fetched primary data and its relationship (e.g. we have an
<code class="highlighter-rouge">employees</code> array and <code class="highlighter-rouge">positions</code> array), we need to associate these
objects:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">employees</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
  <span class="n">e</span><span class="p">.</span><span class="nf">positions</span> <span class="o">=</span> <span class="n">positions</span><span class="p">.</span><span class="nf">select</span> <span class="p">{</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="nb">p</span><span class="p">.</span><span class="nf">employee_id</span> <span class="o">==</span> <span class="n">e</span><span class="p">.</span><span class="nf">id</span> <span class="p">}</span>
<span class="k">end</span></code></pre></figure>

  <p>Occasionally this logic will be non-standard or more complex. Use
<code class="highlighter-rouge">assign_each</code> to customize:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">has_many</span> <span class="ss">:positions</span> <span class="k">do</span>
  <span class="n">assign_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">employee</span><span class="p">,</span> <span class="n">positions</span><span class="o">|</span>
    <span class="n">positions</span><span class="p">.</span><span class="nf">select</span> <span class="p">{</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="nb">p</span><span class="p">.</span><span class="nf">belongs_to?</span><span class="p">(</span><span class="n">employee</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <h4 id="hasmany">5.3 has_many</h4>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">has_many</span> <span class="ss">:positions</span></code></pre></figure>

  <p>Defaults to these common options:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">has_many</span> <span class="ss">:positions</span><span class="p">,</span>
  <span class="ss">foreign_key: :employee_id</span><span class="p">,</span>
  <span class="ss">primary_key: :id</span><span class="p">,</span>
  <span class="ss">resource: </span><span class="no">PositionResource</span></code></pre></figure>

  <p>Which would cause the following query when sideloading:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">PositionResource</span><span class="p">.</span><span class="nf">all</span><span class="p">({</span> <span class="ss">filter: </span><span class="p">{</span> <span class="n">employee_id</span> <span class="o">=&gt;</span> <span class="n">employee_ids</span> <span class="p">}</span> <span class="p">})</span></code></pre></figure>

  <p>This means <strong>we need to make sure that filter is supported</strong>:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">PositionResource</span> <span class="o">&lt;</span> <span class="no">ApplicationResource</span>
  <span class="n">attribute</span> <span class="ss">:employee_id</span><span class="p">,</span> <span class="ss">:integer</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:filterable</span><span class="p">]</span>
  <span class="c1"># ... code ...</span>
<span class="k">end</span></code></pre></figure>

  <p>Once we’ve resolved <code class="highlighter-rouge">employees</code> and <code class="highlighter-rouge">positions</code> the resulting objects
would be associated with logic similar to:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">employees</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
  <span class="n">e</span><span class="p">.</span><span class="nf">positions</span> <span class="o">=</span> <span class="n">positions</span><span class="p">.</span><span class="nf">select</span> <span class="p">{</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="nb">p</span><span class="p">.</span><span class="nf">employee_id</span> <span class="o">==</span> <span class="n">e</span><span class="p">.</span><span class="nf">id</span> <span class="p">}</span>
<span class="k">end</span></code></pre></figure>

  <p>And generate a Link:</p>

  <p><code class="highlighter-rouge">/positions?filter[employee_id]=1,2,3</code></p>

  <h4 id="belongsto">5.4 belongs_to</h4>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">belongs_to</span> <span class="ss">:employee</span></code></pre></figure>

  <p>Defaults to these common options:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">belongs_to</span> <span class="ss">:employee</span><span class="p">,</span>
  <span class="ss">foreign_key: :employee_id</span><span class="p">,</span>
  <span class="ss">primary_key: :id</span><span class="p">,</span>
  <span class="ss">resource: </span><span class="no">EmployeeResource</span></code></pre></figure>

  <p>Which would cause the following query when sideloading:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">EmployeeResource</span><span class="p">.</span><span class="nf">all</span><span class="p">({</span> <span class="ss">filter: </span><span class="p">{</span> <span class="nb">id</span> <span class="o">=&gt;</span> <span class="n">position_ids</span> <span class="p">}</span> <span class="p">})</span></code></pre></figure>

  <p>And assign the resulting objects with logic similar to:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">positions</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span>
  <span class="nb">p</span><span class="p">.</span><span class="nf">employee</span> <span class="o">=</span> <span class="n">employees</span><span class="p">.</span><span class="nf">find</span> <span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="nb">p</span><span class="p">.</span><span class="nf">employee_id</span> <span class="o">==</span> <span class="n">e</span><span class="p">.</span><span class="nf">id</span> <span class="p">}</span>
<span class="k">end</span></code></pre></figure>

  <p>And generate a Link:</p>

  <p><code class="highlighter-rouge">/employees?filter[id]=1,2,3</code></p>

  <h4 id="hasone">5.4 has_one</h4>

  <p><code class="highlighter-rouge">has_one</code> works exactly like <code class="highlighter-rouge">has_many</code>, but only one record will be
returned. When sideloading this will be a single element, much like
<code class="highlighter-rouge">belongs_to</code>.</p>

  <p>There is one small caveat: Links always point to an <code class="highlighter-rouge">index</code> action, so
we can apply filters. That means following <em><code class="highlighter-rouge">has_one</code> Link will lead to
an array</em>, and you should select the first record.</p>

  <h5 id="faux-hasone">5.4.1 Faux has_one</h5>

  <p>A “Faux Has One” occurrs when there is more than one record of
associated data, but we only want to return the <em>first</em> record in that
array. Consider this <code class="highlighter-rouge">ActiveRecord</code> relationship:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># app/models/employee.rb</span>
<span class="n">has_many</span> <span class="ss">:positions</span>
<span class="n">has_one</span> <span class="ss">:current_position</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">created_at: :desc</span><span class="p">)</span> <span class="p">}</span>

<span class="no">Employee</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="s1">'current_position'</span><span class="p">).</span><span class="nf">to_a</span>

<span class="c1"># SELECT * FROM employees</span>
<span class="c1"># SELECT * FROM positions WHERE employee_id IN (?) ORDER BY created_at DESC</span></code></pre></figure>

  <p>When we eager load, <em>more than one Position is returned from the
database query</em>. Assigning only the first record and dropping the rest
occurs in ruby, not the database query.</p>

  <p>The same thing happens in Graphiti:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># app/resources/employee_resource.rb</span>
<span class="n">has_many</span> <span class="ss">:positions</span>
<span class="n">has_one</span> <span class="ss">:current_position</span> <span class="k">do</span>
  <span class="n">params</span> <span class="k">do</span> <span class="o">|</span><span class="nb">hash</span><span class="o">|</span>
    <span class="nb">hash</span><span class="p">[</span><span class="ss">:sort</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'-created_at'</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">EmployeeResource</span><span class="p">.</span><span class="nf">all</span><span class="p">(</span><span class="ss">include: </span><span class="s1">'current_position'</span><span class="p">)</span>
<span class="c1"># PositionResource.all({</span>
<span class="c1">#   filter: { employee_id: employee_ids },</span>
<span class="c1">#   sort: '-created_at'</span>
<span class="c1"># })</span></code></pre></figure>

  <p>Though everything works as expected, a large number of Position records
can incur a performance penalty (as we’d be instantiating a large number
of ActiveRecord objects).</p>

  <p>For this reason, you are encouraged to model Faux Has One’s in such a
way that the underlying database query only returns the relevant single
record. Imagine if we had a <code class="highlighter-rouge">historical_index</code> column on <code class="highlighter-rouge">positions</code>,
where a value of <code class="highlighter-rouge">1</code> meant “most recent”:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># app/models/employee.rb</span>
<span class="n">has_many</span> <span class="ss">:positions</span>
<span class="n">has_one</span> <span class="ss">:current_position</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">historical_index: </span><span class="mi">1</span><span class="p">)</span> <span class="p">}</span>

<span class="no">Employee</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="s1">'current_position'</span><span class="p">).</span><span class="nf">to_a</span>

<span class="c1"># SELECT * FROM employees</span>
<span class="c1"># SELECT * FROM positions WHERE employee_id IN (?) AND historical_index = 1</span></code></pre></figure>

  <p>We’ve ensured the <em>query itself</em> only returns a single record.
Optimizing a Graphiti API is the same as optimizing queries.</p>

  <h5 id="manytomany">5.5 many_to_many</h5>

  <blockquote>
    <p>This relationship is specific to relational databases that use a “join
table” between two tables.</p>
  </blockquote>

  <p>Though you can make this work for other ORMs/clients, it’s easiest to
explain by focusing on <code class="highlighter-rouge">ActiveRecord</code>.</p>

  <p>First, <strong>you must use <a href="https://guides.rubyonrails.org/association_basics.html#the-has-many-through-association">has_many :through</a> and not has_and_belongs_to_many</strong>:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Employee</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:team_memberships</span>
  <span class="n">has_many</span> <span class="ss">:teams</span><span class="p">,</span> <span class="n">through</span> <span class="ss">:team_memberships</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">TeamMembership</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:employee</span>
  <span class="n">belongs_to</span> <span class="ss">:team</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Team</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:team_memberships</span>
  <span class="n">has_many</span> <span class="ss">:employees</span><span class="p">,</span> <span class="ss">through: :team_memberships</span>
<span class="k">end</span></code></pre></figure>

  <p>You can always expose <code class="highlighter-rouge">team_memberships</code> to your API - particularly
useful if that table holds metadata about the relationship.</p>

  <p>Other times, however, clients of the API should not have knowledge of
this implementation detail. In these cases, use <code class="highlighter-rouge">many_to_many</code>:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">EmployeeResource</span> <span class="o">&lt;</span> <span class="no">ApplicationResource</span>
  <span class="n">many_to_many</span> <span class="ss">:teams</span>
<span class="k">end</span>
<span class="c1"># Generates the Link</span>
<span class="c1"># /teams?filter[employee_id]=1,2,3</span>

<span class="k">class</span> <span class="nc">TeamResource</span> <span class="o">&lt;</span> <span class="no">ApplicationResource</span>
  <span class="n">many_to_many</span> <span class="ss">:employees</span>
<span class="k">end</span>
<span class="c1"># Generates the Link</span>
<span class="c1"># /teams?filter[team_id]=1,2,3</span></code></pre></figure>

  <p>The <code class="highlighter-rouge">many_to_many</code> call will automatically add a Filter to the
associated resource. The logic for that filter, in the case of <code class="highlighter-rouge">ActiveRecord</code>:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># app/resources/employee_resource.rb</span>

<span class="n">filter</span> <span class="ss">:team_id</span><span class="p">,</span> <span class="ss">:integer</span> <span class="k">do</span>
  <span class="n">eq</span> <span class="k">do</span> <span class="o">|</span><span class="n">scope</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
    <span class="n">scope</span>
      <span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:team_memberships</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">team_memberships: </span><span class="p">{</span> <span class="ss">team_id: </span><span class="n">value</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <p>To customize the foreign key, you will need to specify a hash rather
than a symbol. The hash key is the relationship name, so the above is
equivalent to</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># app/resources/employee_resource.rb</span>

<span class="n">many_to_many</span> <span class="ss">:teams</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="p">{</span> <span class="ss">team_memberships: :team_id</span> <span class="p">}</span></code></pre></figure>

  <p>If using ActiveRecord, and the API relationship name does not match your
Model relationship name, use <code class="highlighter-rouge">:as</code> to specify the model relationship
that should be used to derive the query:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># The API relationship is "teams", ActiveRecord has "groups"</span>
<span class="n">many_to_many</span> <span class="ss">:teams</span><span class="p">,</span> <span class="ss">as: :groups</span></code></pre></figure>

  <h5 id="polymorphicbelongsto">5.5 polymorphic_belongs_to</h5>

  <p>With polymorphic associations, a Resource can belong to more than one other Resource, on a single association. Though these relationships are not specific to <code class="highlighter-rouge">ActiveRecord</code>, we’ll use <code class="highlighter-rouge">ActiveRecord</code> conventions to describe the use case.</p>

  <p>Given the following <a href="https://guides.rubyonrails.org/association_basics.html#polymorphic-associations">polymorphic ActiveRecords</a>:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Note</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:notable</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Employee</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:notes</span><span class="p">,</span> <span class="ss">as: :notable</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Department</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:notes</span><span class="p">,</span> <span class="ss">as: :notable</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Team</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:notes</span><span class="p">,</span> <span class="ss">as: :notable</span>
<span class="k">end</span></code></pre></figure>

  <p>By <code class="highlighter-rouge">ActiveRecord</code> convention, the <code class="highlighter-rouge">notes</code> table would have columns
<code class="highlighter-rouge">notable_id</code> and <code class="highlighter-rouge">notable_type</code>.</p>

  <p>Graphiti has the same concept. In this case we would group all the notes
by a given <code class="highlighter-rouge">notable_type</code>, and follow a different <code class="highlighter-rouge">belongs_to</code>
association for each group:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># app/resources/note_resource.rb</span>
<span class="n">polymorphic_belongs_to</span> <span class="ss">:notable</span> <span class="k">do</span>
  <span class="n">group_by</span><span class="p">(</span><span class="ss">:notable_type</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">on</span><span class="p">(</span><span class="ss">:Employee</span><span class="p">)</span>
    <span class="n">on</span><span class="p">(</span><span class="ss">:Department</span><span class="p">)</span>
    <span class="n">on</span><span class="p">(</span><span class="ss">:Team</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <p>The <code class="highlighter-rouge">on</code> DSL is shorthand for a <code class="highlighter-rouge">belongs_to</code> relationship that accepts
all the usual options and customizations:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">on</span><span class="p">(</span><span class="ss">:Employee</span><span class="p">).</span><span class="nf">belongs_to</span> <span class="ss">:employee</span><span class="p">,</span>
  <span class="ss">resource: </span><span class="no">EmployeeResource</span>
  <span class="c1"># ... etc ...</span></code></pre></figure>

  <p>In other words: group all Notes by <code class="highlighter-rouge">notable_type</code>, and for all that have
the value of <code class="highlighter-rouge">"Employee"</code> use the <code class="highlighter-rouge">belongs_to :employee</code> relationship
for further querying.</p>

  <h5 id="polymorphichasmany">5.6 polymorphic_has_many</h5>

  <p>Continuing from the prior section, the corresponding association of a
<code class="highlighter-rouge">polymorphic_belongs_to</code> is a <code class="highlighter-rouge">polymorphic_has_many</code>:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">EmployeeResource</span> <span class="o">&lt;</span> <span class="no">ApplicationResource</span>
  <span class="n">polymorphic_has_many</span> <span class="ss">:notes</span><span class="p">,</span> <span class="ss">as: :notable</span>
<span class="k">end</span></code></pre></figure>

  <p>Predictably, this causes the query:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">NoteResource</span><span class="p">.</span><span class="nf">all</span><span class="p">({</span>
  <span class="ss">filter: </span><span class="p">{</span>
    <span class="ss">notable_type: </span><span class="s1">'Employee'</span><span class="p">,</span>
    <span class="ss">notable_id: </span><span class="n">employee_ids</span>
  <span class="p">}</span>
<span class="p">})</span></code></pre></figure>

  <p>And the Link</p>

  <p><code class="highlighter-rouge">/notes?filter[notable_id]=1,2,3&amp;filter[notable_type]=Employee</code></p>

  <p>Which means the following filters are required:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">NoteResource</span> <span class="o">&lt;</span> <span class="no">ApplicationResource</span>
  <span class="n">attribute</span> <span class="ss">:notable_id</span><span class="p">,</span> <span class="ss">:integer</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:filterable</span><span class="p">]</span>
  <span class="n">attribute</span> <span class="ss">:notable_type</span><span class="p">,</span> <span class="ss">:string</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:filterable</span><span class="p">]</span>
  <span class="c1"># ... code ...</span>
<span class="k">end</span></code></pre></figure>

  <h2 id="generators">6 Generators</h2>

  <p>To generate a Resource:</p>

  <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>rails generate graphiti:resource NAME <span class="o">[</span>attribute:type] <span class="o">[</span>options]</code></pre></figure>

  <p>For example:</p>

  <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>rails generate graphiti:resource Employee first_name:string age:integer</code></pre></figure>

  <p>Will add a route, controller, resource, and tests.</p>

  <p>Limit the actions this resource supports with <code class="highlighter-rouge">-a</code>:</p>

  <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>rails generate graphiti:resource Employee -a index show</code></pre></figure>

  <h2 id="persisting">7 Persisting</h2>

  <p>Graphiti allows writing a graph of data in a single request. We’ll do
the work of parsing the graph and ordering operations, so you can focus
on the part you care about: the logic for actually persisting an object.</p>

  <p>By default, persistence operations are handled by your adapter. The
“expanded” view of the ActiveRecord implementation is below:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># app/resources/employee_resource.rb</span>

<span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
  <span class="n">employee</span> <span class="o">=</span> <span class="no">Employee</span><span class="p">.</span><span class="nf">new</span>
  <span class="n">attributes</span><span class="p">.</span><span class="nf">each_pair</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
    <span class="n">employee</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="ss">:"</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="ss">="</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">employee</span><span class="p">.</span><span class="nf">save</span>
  <span class="n">employee</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
  <span class="n">employee</span> <span class="o">=</span> <span class="no">EmployeeResource</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">attributes</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="ss">:id</span><span class="p">)).</span><span class="nf">data</span>
  <span class="n">attributes</span><span class="p">.</span><span class="nf">each_pair</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
    <span class="n">employee</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="ss">:"</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="ss">="</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">employee</span><span class="p">.</span><span class="nf">save</span>
  <span class="n">employee</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">destroy</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
  <span class="n">employee</span> <span class="o">=</span> <span class="no">EmployeeResource</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">attributes</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="ss">:id</span><span class="p">)).</span><span class="nf">data</span>
  <span class="n">employee</span><span class="p">.</span><span class="nf">destroy</span>
  <span class="n">employee</span>
<span class="k">end</span></code></pre></figure>

  <ul>
    <li>You are encouraged <strong>not</strong> to override these directly. Instead, use
hooks (see next section).</li>
    <li>We’ll process any <code class="highlighter-rouge">writable: false</code> or guarded attributes prior to
these methods.</li>
    <li>After these methods, we’ll check the Model instance for validation
errors, rolling back the transaction if any Model in the graph is
invalid.</li>
    <li>These methods <strong>must return the Model instance</strong>.</li>
  </ul>

  <h3 id="persistence-lifecycle-hooks">7.1 Persistence Lifecycle Hooks</h3>

  <p>Let’s dive into a persistence request. If you look at the code snippets in
the prior section, the flow breaks down into 3 steps:</p>

  <ul>
    <li>Build or find the model</li>
    <li>Assign attributes to the model</li>
    <li>Save</li>
  </ul>

  <p>You can hook into each step:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">PostResource</span> <span class="o">&lt;</span> <span class="no">ApplicationResource</span>
  <span class="n">before_attributes</span> <span class="k">do</span> <span class="o">|</span><span class="n">attributes</span><span class="o">|</span>
    <span class="c1"># Before attributes have been assigned to the model</span>
  <span class="k">end</span>

  <span class="n">after_attributes</span> <span class="k">do</span> <span class="o">|</span><span class="n">model</span><span class="o">|</span>
    <span class="c1"># After attributes have been assigned to the model</span>
  <span class="k">end</span>

  <span class="n">around_attributes</span> <span class="ss">:do_around_attributes</span>

  <span class="k">def</span> <span class="nf">do_around_attributes</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
    <span class="c1"># before</span>
    <span class="n">model_instance</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">attributes</span>
    <span class="c1"># after</span>
  <span class="k">end</span>

  <span class="n">before_save</span> <span class="k">do</span> <span class="o">|</span><span class="n">model</span><span class="o">|</span>
    <span class="c1"># After attributes assigned, but before persisting</span>
  <span class="k">end</span>

  <span class="n">after_save</span> <span class="k">do</span> <span class="o">|</span><span class="n">model</span><span class="o">|</span>
    <span class="c1"># After model has been saved</span>
  <span class="k">end</span>

  <span class="n">around_save</span> <span class="ss">:do_around_save</span>

  <span class="k">def</span> <span class="nf">do_around_save</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="c1"># before</span>
    <span class="k">yield</span> <span class="n">model</span>
    <span class="c1"># after</span>
  <span class="k">end</span>

  <span class="c1"># This is an *override*</span>
  <span class="c1"># During #create, build a blank model instance</span>
  <span class="c1"># By default, we'd call adapter.build(model_class)</span>
  <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">model_class</span><span class="p">)</span>
    <span class="n">model_class</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>

  <span class="c1"># This is an *override*</span>
  <span class="c1"># During #create/#update, assign new attributes to the model instance</span>
  <span class="c1"># By default, we'd call adapter.assign_attributes(model_instance, attributes)</span>
  <span class="k">def</span> <span class="nf">assign_attributes</span><span class="p">(</span><span class="n">model_instance</span><span class="p">,</span> <span class="n">attributes</span><span class="p">)</span>
    <span class="n">attributes</span><span class="p">.</span><span class="nf">each_pair</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
      <span class="n">model_instance</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="ss">:"</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="ss">="</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># This is an *override*</span>
  <span class="c1"># During #create/#update, actually save the model instance</span>
  <span class="c1"># By default, we'd call adapter.save(model_instance)</span>
  <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">model_instance</span><span class="p">)</span>
    <span class="n">model_instance</span><span class="p">.</span><span class="nf">save</span>
  <span class="k">end</span>

  <span class="c1"># This is an *override*</span>
  <span class="c1"># During #destroy, actually save the model instance</span>
  <span class="c1"># By default, we'd call adapter.destroy(model_instance)</span>
  <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">model_instance</span><span class="p">)</span>
    <span class="n">model</span><span class="p">.</span><span class="nf">destroy</span>
  <span class="k">end</span>

  <span class="c1"># Finally, you may want to hook around *all* the above steps:</span>
  <span class="c1"># Only applies to #create/#update</span>
  <span class="n">around_persistence</span> <span class="ss">:do_around_persistence</span>

  <span class="k">def</span> <span class="nf">do_around_persistence</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
    <span class="n">attributes</span><span class="p">[</span><span class="ss">:foo</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'bar'</span>
    <span class="n">model</span> <span class="o">=</span> <span class="k">yield</span> <span class="c1"># build/find, assign attrs, save</span>
    <span class="n">model</span><span class="p">.</span><span class="nf">update_counter_cache</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <ul>
    <li>All hooks have <code class="highlighter-rouge">only/except</code> options, e.g. <code class="highlighter-rouge">before_attributes only:
[:update]</code></li>
    <li>Most hooks can be called with an in-line block, or by passing a method
name (e.g. <code class="highlighter-rouge">before_attriubtes :do_something</code>). The exception is
<code class="highlighter-rouge">around_*</code> hooks, which <em>must</em> be called with a method name.</li>
  </ul>

  <p>When persisting multiple objects at once, we’ll open a database
transaction, process each model individually, ensure all models pass
validation, then close the transaction. This means that if you raise an
error at any point, or any model does not pass validations, the
transaction will be rolled back.</p>

  <p>You may want to perform an operation after all models have been
processed and validated, but before the transaction is closed. One
example is sending an email - you don’t want to send if the models were
invalid, so <code class="highlighter-rouge">after_save</code> wouldn’t work. And you still want to do it
<em>within</em> the transaction, so if your email server is down and an error
is raised the transaction gets rolled back.</p>

  <p>For this scenario, use <code class="highlighter-rouge">before_commit</code>:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">before_commit</span> <span class="k">do</span> <span class="o">|</span><span class="n">model</span><span class="o">|</span>
  <span class="no">PostMailer</span><span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="ss">post: </span><span class="n">model</span><span class="p">).</span><span class="nf">some_email</span><span class="p">.</span><span class="nf">deliver</span>
<span class="k">end</span></code></pre></figure>

  <h3 id="sideposting">7.2 Sideposting</h3>

  <p>The act of persisting multiple Resources in a single request is called
<strong>Sideposting</strong>. The payload mirrors the <strong>sideloading</strong> payload for
read operations, with minor additions.</p>

  <p>Let’s create a Post and associate it to an existing Blog in a single
request:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># POST /api/v1/posts</span>
<span class="p">{</span>
  <span class="ss">type: </span><span class="s1">'posts'</span><span class="p">,</span>
  <span class="ss">attributes: </span><span class="p">{</span> <span class="ss">title: </span><span class="s1">'My post'</span> <span class="p">},</span>
  <span class="ss">relationships: </span><span class="p">{</span>
    <span class="ss">blog: </span><span class="p">{</span>
      <span class="ss">data: </span><span class="p">{</span>
        <span class="ss">id: </span><span class="s1">'1'</span><span class="p">,</span>
        <span class="ss">type: </span><span class="s1">'blogs'</span><span class="p">,</span>
        <span class="ss">method: </span><span class="s1">'update'</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

  <p>The critical addition here is the <code class="highlighter-rouge">method</code> key. When we persist RESTful
Resources, we send a corresponding HTTP verb. This follows the same
pattern, adding a verb for each Resource in the graph. <code class="highlighter-rouge">method</code> can be
one of:</p>

  <ul>
    <li><code class="highlighter-rouge">create</code></li>
    <li><code class="highlighter-rouge">update</code></li>
    <li><code class="highlighter-rouge">destroy</code></li>
    <li><code class="highlighter-rouge">disassociate</code> (e.g. <code class="highlighter-rouge">null</code> foreign key)</li>
  </ul>

  <p>When we sidepost, all objects will be persisted within the same database
transaction, which rolls back if an error is raised or any objects are invalid.</p>

  <h4 id="create">7.2.1 Create</h4>

  <p>Let’s say we want to create a Post and its Blog in a single request.
You’ll note that we don’t have the <code class="highlighter-rouge">id</code> key to generate a <a href="http://jsonapi.org/format/#document-resource-identifier-objects">Resource
Identifier</a> (combination of <code class="highlighter-rouge">id</code> and <code class="highlighter-rouge">type</code>
that uniquely identifies a Resource).</p>

  <p>To accomodate this, send an ephemeral <code class="highlighter-rouge">temp-id</code> (any UUID):</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="p">{</span>
  <span class="c1"># POST /api/v1/posts</span>
  <span class="p">{</span>
    <span class="ss">type: </span><span class="s1">'posts'</span><span class="p">,</span>
    <span class="ss">attributes: </span><span class="p">{</span> <span class="ss">title: </span><span class="s1">'My post'</span> <span class="p">},</span>
    <span class="ss">relationships: </span><span class="p">{</span>
      <span class="ss">blog: </span><span class="p">{</span>
        <span class="ss">data: </span><span class="p">{</span>
          <span class="ss">:'temp-id'</span> <span class="o">=&gt;</span> <span class="s1">'abc123'</span><span class="p">,</span>
          <span class="ss">type: </span><span class="s1">'blogs'</span><span class="p">,</span>
          <span class="ss">method: </span><span class="s1">'create'</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="ss">included: </span><span class="p">[</span>
      <span class="p">{</span>
        <span class="ss">:'temp-id'</span> <span class="o">=&gt;</span> <span class="s1">'abc123'</span>
        <span class="ss">type: </span><span class="s1">'blogs'</span><span class="p">,</span>
        <span class="ss">attributes: </span><span class="p">{</span> <span class="ss">name: </span><span class="s1">'New Blog'</span> <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

  <p>This random UUID:</p>

  <ul>
    <li>Connects relevant sections of the payload.</li>
    <li>Tells clients how to associate their in-memory objects with the ids returned from the server.</li>
  </ul>

  <h4 id="expanded-example">7.2.2 Expanded Example</h4>

  <p>Here we’re updating a Post, changing the name of its associated Blog, creating a Tag, deleting one Comment, and disassociating (<code class="highlighter-rouge">null</code> foreign key) a different Comment, all in a single request:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="p">{</span>
  <span class="ss">data: </span><span class="p">{</span>
    <span class="ss">type: </span><span class="s1">'posts'</span><span class="p">,</span>
    <span class="ss">id: </span><span class="mi">123</span><span class="p">,</span>
    <span class="ss">attributes: </span><span class="p">{</span> <span class="ss">title: </span><span class="s1">'Updated!'</span> <span class="p">},</span>
    <span class="ss">relationships: </span><span class="p">{</span>
      <span class="ss">blog: </span><span class="p">{</span>
        <span class="ss">data: </span><span class="p">{</span>
          <span class="ss">type: </span><span class="s1">'blogs'</span><span class="p">,</span>
          <span class="ss">id: </span><span class="mi">123</span><span class="p">,</span>
          <span class="ss">method: </span><span class="s1">'update'</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="ss">tags: </span><span class="p">{</span>
        <span class="ss">data: </span><span class="p">[{</span>
          <span class="ss">type: </span><span class="s1">'tags'</span><span class="p">,</span>
          <span class="n">temp</span><span class="o">-</span><span class="ss">id: </span><span class="s1">'s0m3uu1d'</span><span class="p">,</span>
          <span class="ss">method: </span><span class="s1">'create'</span>
        <span class="p">}]</span>
      <span class="p">},</span>
      <span class="ss">comments: </span><span class="p">{</span>
        <span class="ss">data: </span><span class="p">[</span>
          <span class="p">{</span>
            <span class="ss">type: </span><span class="s1">'comments'</span><span class="p">,</span>
            <span class="ss">id: </span><span class="s1">'123'</span><span class="p">,</span>
            <span class="ss">method: </span><span class="s1">'destroy'</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="ss">type: </span><span class="s1">'comments'</span><span class="p">,</span>
            <span class="ss">id: </span><span class="s1">'456'</span><span class="p">,</span>
            <span class="ss">method: </span><span class="s1">'disassociate'</span>
          <span class="p">}</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="ss">included: </span><span class="p">[</span>
    <span class="p">{</span>
      <span class="ss">type: </span><span class="s1">'tags'</span><span class="p">,</span>
      <span class="ss">:'temp-id'</span> <span class="o">=&gt;</span> <span class="s1">'s0m3uu1d'</span><span class="p">,</span>
      <span class="ss">attributes: </span><span class="p">{</span> <span class="ss">name: </span><span class="s1">'Important'</span> <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="ss">type: </span><span class="s1">'blogs'</span><span class="p">,</span>
      <span class="ss">id: </span><span class="o">=&gt;</span> <span class="s1">'123'</span><span class="p">,</span>
      <span class="ss">attributes: </span><span class="p">{</span> <span class="ss">name: </span><span class="s1">'Updated!'</span> <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span></code></pre></figure>

  <h3 id="validation-errors">7.3 Validation Errors</h3>

  <p>When a persistence operation is attempted but the corresponding Resource
is invalid, the transaction will be rolled back and an <a href="http://jsonapi.org/format/#errors">errors payload</a> will be returned
with a <code class="highlighter-rouge">422</code> response code:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="p">{</span>
  <span class="ss">errors: </span><span class="p">[{</span>
    <span class="ss">code:  </span><span class="s1">'unprocessable_entity'</span><span class="p">,</span>
    <span class="ss">status: </span><span class="s1">'422'</span><span class="p">,</span>
    <span class="ss">title: </span><span class="s2">"Validation Error"</span><span class="p">,</span>
    <span class="ss">detail: </span><span class="s2">"Title can't be blank"</span><span class="p">,</span>
    <span class="ss">source: </span><span class="p">{</span> <span class="ss">pointer: </span><span class="s1">'/data/attributes/title'</span> <span class="p">},</span>
    <span class="ss">meta: </span><span class="p">{</span>
      <span class="ss">attribute: :title</span><span class="p">,</span>
      <span class="ss">message: </span><span class="s2">"can't be blank"</span><span class="p">,</span>
      <span class="ss">code: :blank</span>
    <span class="p">}</span>
  <span class="p">}]</span>
<span class="p">}</span></code></pre></figure>

  <p>To get this functionality, your Model must adhere to the
<a href="https://api.rubyonrails.org/classes/ActiveModel/Validations.html">ActiveModel::Validations API</a>.</p>

  <p>You get this for free with ActiveRecord, or it can be mixed in to any
PORO:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Post</span>
  <span class="kp">include</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Validations</span>
  <span class="n">validates</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span></code></pre></figure>

  <p>Errors on associations will have a slightly expanded payload:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="p">{</span>
  <span class="ss">errors: </span><span class="p">[{</span>
    <span class="ss">code: </span><span class="s1">'unprocessable_entity'</span><span class="p">,</span>
    <span class="ss">status: </span><span class="s1">'422'</span><span class="p">,</span>
    <span class="ss">title: </span><span class="s1">'Validation Error'</span><span class="p">,</span>
    <span class="ss">detail: </span><span class="s2">"Name can't be blank"</span><span class="p">,</span>
    <span class="ss">source: </span><span class="p">{</span> <span class="ss">pointer: </span><span class="s1">'/data/attributes/name'</span> <span class="p">},</span>
    <span class="ss">meta: </span><span class="p">{</span>
      <span class="ss">relationship: </span><span class="p">{</span>
        <span class="ss">attribute: :name</span><span class="p">,</span>
        <span class="ss">message: </span><span class="s2">"can't be blank"</span><span class="p">,</span>
        <span class="ss">code: :blank</span><span class="p">,</span>
        <span class="ss">name: :pets</span><span class="p">,</span>
        <span class="ss">id: </span><span class="s1">'444'</span><span class="p">,</span>
        <span class="ss">type: </span><span class="s1">'pets'</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}]</span>
<span class="p">}</span></code></pre></figure>

  <p>When <a href="#sideposting">Sideposting</a>, the errors payload will contain all
invalid Resources in the graph.</p>

  <h2 id="read-on-write">7.4 Read on Write</h2>

  <p>By default, the response of a persistence operation will mirror your
request. But sometimes you need control over the response. The most
common scenario is sideloading an additional entity - imagine creating
an order, and wanting the order’s shipping information to come back in
the response.</p>

  <p>You can do this by POSTing the payload as normal, but adding query
parameters to the URL:</p>

  <div class="highlighter-rouge"><pre class="highlight"><code>POST /api/v1/orders?include=shipping_information

{
  type: 'orders',
  attributes: { ... }
}
</code></pre>
  </div>

  <p>This will sideload the shipping information in the response. When using
<a href="https://graphiti-api.github.io/graphiti/js/home">Spraypaint</a>, do this with:</p>

  <figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">order</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span> <span class="na">returnScope</span><span class="p">:</span> <span class="nx">Order</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">'shipping_information'</span><span class="p">)</span> <span class="p">})</span></code></pre></figure>

  <h2 id="context">8 Context</h2>

  <p>All resources have access to <code class="highlighter-rouge">#context</code>. If you’re using Rails,
<code class="highlighter-rouge">context</code> is the controller instance processing the request.</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># app/resources/post_resource.rb</span>
<span class="n">attribute</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">:boolean</span><span class="p">,</span> <span class="ss">writable: :admin?</span>

<span class="k">def</span> <span class="nf">admin?</span>
  <span class="n">context</span><span class="p">.</span><span class="nf">current_user</span><span class="p">.</span><span class="nf">admin?</span>
<span class="k">end</span></code></pre></figure>

  <p>Because <code class="highlighter-rouge">current_user</code> is so common, we recommend putting this in
<code class="highlighter-rouge">ApplicationResource</code>:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># app/resources/application_resource.rb</span>
<span class="k">class</span> <span class="nc">ApplicationResource</span> <span class="o">&lt;</span> <span class="no">Graphiti</span><span class="o">::</span><span class="no">Resource</span>
  <span class="c1"># ... code ...</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="n">context</span><span class="p">.</span><span class="nf">current_user</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># app/resources/post_resource.rb</span>
<span class="k">class</span> <span class="nc">PostResource</span> <span class="o">&lt;</span> <span class="no">ApplicationResource</span>
  <span class="c1"># ... code ...</span>
  <span class="k">def</span> <span class="nf">admin?</span>
    <span class="n">current_user</span><span class="p">.</span><span class="nf">admin?</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <p>You can manually set context with <code class="highlighter-rouge">with_context</code>:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">ctx</span> <span class="o">=</span> <span class="no">OpenStruct</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">current_user: </span><span class="no">User</span><span class="p">.</span><span class="nf">first</span><span class="p">)</span>
<span class="no">Graphiti</span><span class="p">.</span><span class="nf">with_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="k">do</span>
  <span class="c1"># current_user == ctx.current_user</span>
  <span class="no">PostResource</span><span class="p">.</span><span class="nf">all</span>
<span class="k">end</span></code></pre></figure>

  <p><br />
<br /></p>

</div>

        </div>
      </div>
    </main>
    <div class="main-footer main-footer--dark">
  <div class="container">
    <div class="row">
      <div class="col-sm-4 menu">
        <h3>Overview</h3>
        <ul>
          <li>
            <a href="https://graphiti-api.github.io/graphiti/quickstart">Quickstart</a>
          </li>
          <li>
            <a href="https://graphiti-api.github.io/graphiti/tutorial">Tutorial</a>
          </li>
          <li>
            <a href="https://graphiti-api.github.io/graphiti/guides">Guides</a>
          </li>
        </ul>
      </div>
      <div class="col-sm-4 menu">
        <h3>Contact</h3>
        <ul>
          <li>
            <a target="_blank" href="https://join.slack.com/t/graphiti-api/shared_invite/enQtMjkyMTA3MDgxNTQzLWVkMDM3NTlmNTIwODY2YWFkMGNiNzUzZGMzOTY3YmNmZjBhYzIyZWZlZTk4YmI1YTI0Y2M0OTZmZGYwN2QxZjg">Slack Chat</a>
          </li>
          <li>
            <a href="mailto:richmolj@gmail.com">Email</a>
          </li>
        </ul>
      </div>
      <div class="col-sm-4 menu">
        <h3>Related</h3>
        <ul>
          <li>
            <a target="_blank" href="http://jsonapi.org">JSONAPI Spec</a>
          </li>
          <li>
            <a target="_blank" href="http://jsonapi-rb.org">jsonapi-rb</a>
          </li>
          <li>
            <a target="_blank" href="https://vuejs.org/">VueJS</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>

    <script type="text/javascript">
$(function () {

  var flipTabs = function() {
    var isTS = true;
    if (localStorage.getItem('js-lang') === 'javascript') {
      isTS = false;
    }

    $('.code-tabs').each(function(index, el) {
      if (isTS) {
        console.log('hiding js');
        $($(el).children()[1]).hide();
        $($(el).children()[0]).show();
      } else {
        console.log('hiding ts');
        $($(el).children()[0]).hide();
        $($(el).children()[1]).show();
      }
    });

    if (isTS) {
      $('.tab.typescript').addClass('active');
      $('.tab.javascript').removeClass('active');
    } else {
      $('.tab.typescript').removeClass('active');
      $('.tab.javascript').addClass('active');
    }
  }

  $('.tab').click(function() {
    if ($(this).hasClass('typescript')) {
      localStorage.setItem('js-lang', 'typescript');
    } else {
      localStorage.setItem('js-lang', 'javascript');
    }

    flipTabs();
  });

  flipTabs();
})
</script>

  </body>
</html>
